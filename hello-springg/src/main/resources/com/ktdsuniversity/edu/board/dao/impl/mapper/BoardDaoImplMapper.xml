<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.board.dao.impl.BoardDaoImpl"><!-- ctrl 눌렀을 때 이동되어야 정상 -->
    <select id="selectBoardAllCount" resultType="_int">
      SELECT COUNT(ID)
        FROM BOARD
       WHERE DEL_YN = 'N'
    </select>
    <select id="selectBoardList"
            resultType="com.ktdsuniversity.edu.board.vo.BoardVO">
      SELECT ROW_NUMBER() OVER(ORDER BY ID) "NUMBER"
           , ID
		   , SUBJECT
		   , CONTENT
		   , EMAIL
		   , VIEW_CNT
		   , TO_CHAR(CRT_DT, 'YYYY-MM-DD') AS CRT_DT
		   , TO_CHAR(MDFY_DT, 'YYYY-MM-DD') AS MDFY_DT
		   , DEL_YN
	    FROM BOARD
	   WHERE DEL_YN = 'N'
	   ORDER BY "NUMBER" DESC 
    </select>
      <insert id="insertNewBoard" parameterType="com.ktdsuniversity.edu.board.vo.RequestCreateBoardVO"><!--반환 타입 int라서 resultType 못씀 resultType은 select에서만 사용. 파라미터는 적어야 함-->
        <selectKey keyProperty="id" order="BEFORE" resultType="string"><!-- 이게 먼저 실행되어서 (order="BEFORE" : insert 전에 실행해라) id 값을 insert에 넣어줘야 함. resultType 적어줘야 함. java.lang.String -> string -->
            SELECT 'AR-' || TO_CHAR(SYSDATE, 'YYYYMMDD-') || LPAD(SEQ_BOARD_PK.NEXTVAL, 6, '0') 
              FROM DUAL
        </selectKey>
        INSERT INTO BOARD
        (ID
        , SUBJECT
        , CONTENT
        , EMAIL
        , VIEW_CNT
        , CRT_DT
        , MDFY_DT
        , DEL_YN
        , FILE_GROUP_ID)
        VALUES(#{id}
        , #{subject} <!-- mybatis 문법은 ? (사용자가 보내준 데이터) 대신 다른 걸 씀 -->
        , #{content}
        , #{email}
        , 0
        , SYSDATE 
        , SYSDATE
        , 'N'
        , #{fileGroupId})<!-- 세미콜론 안 가져와야함 -->
    </insert>
    <update id="updateViewCntById" parameterType="string" >
     UPDATE BOARD
         SET VIEW_CNT = VIEW_CNT + 1
         WHERE ID = #{_parameter}<!-- #{}에 아무거나 적어도 됨. 공식은 _parameter로 씀.  parameterType="string"로 string인 것이 #{}-->
           AND DEL_YN = 'N'
    </update>
    <resultMap type="com.ktdsuniversity.edu.board.vo.BoardVO" id="BoardVOMap" autoMapping="true"><!-- autoMapping을 true로 하면 pk 제외 나머지는 자동으로 들어감 (BoardVO에 해당하는 것만)  -->
      <id column="ID" property="id"/> <!-- 결과중 pk만 가져옴  BoardVO의 pk 변수명을 property에 적음-->
      <!--<result column="SUBJECT" property="subject"/> id는 써야햐고 result는 생략 가능-->
      <association property="fileGroupVO" javaType="com.ktdsuniversity.edu.file.vo.FileGroupVO" autoMapping="true">
        <id column="FILE_GROUP_ID" property="fileGroupId"/>
        <collection property="file" javaType= "list" ofType="com.ktdsuniversity.edu.file.vo.FileVO" autoMapping="true">
            <id column="FILE_ID" property="fileId"/>
        </collection>
        <!-- 1 : n file 정보를 넣어줌 (리스트) -->
        <!-- property는 객체 변수명. ofType은 제네릭 -->
      </association> 
      <!-- 1:1 관계에 데이터를 넣어주는 태그, type은 경로 -->
    </resultMap><!-- join된 쿼리의 결과를 단일 인스턴스로 받을 수 있도록 해준다 -->
    <select id="selectBoardById" parameterType="string" resultMap="BoardVOMap"><!-- 단일 테이블에서 가져올 때는 resultType, join 테이블은 다른 거 써야함-->
		SELECT B.ID
		     , B.SUBJECT
		     , B.CONTENT
		     , B.EMAIL
		     , B.VIEW_CNT
		     , B.CRT_DT
		     , B.MDFY_DT
		     , B.DEL_YN
		     , F.FILE_GROUP_ID 
		     , F.FILE_COUNT 
		     , F.FILE_ID 
		     , F.FILE_DISPLAY_NAME 
		     , F.FILE_SIZE 
		     , F.FILE_TYPE 
		  FROM BOARD B
		  LEFT OUTER JOIN (SELECT FG.FILE_GROUP_ID 
		                        , FG.FILE_COUNT 
		                        , F.FILE_ID 
		                        , F.FILE_DISPLAY_NAME 
		                        , F.FILE_SIZE
		                        , F.FILE_TYPE
		                     FROM FILE_GROUP FG
		                    INNER JOIN "FILE" F
		                       ON FG.FILE_GROUP_ID = F.FILE_GROUP_ID) F
		   ON B.FILE_GROUP_ID = F.FILE_GROUP_ID 
		 WHERE ID = #{_parameter}
		   AND DEL_YN = 'N'
    </select>
     <update id ="updateBoardModifyById" parameterType="com.ktdsuniversity.edu.board.vo.RequestModifyBoardVO">
    UPDATE BOARD
       SET SUBJECT = #{subject}
         , EMAIL = #{email}
         , CONTENT = #{content}
     WHERE ID = #{id}
       AND DEL_YN = 'N'
    </update>
    <update id ="deleteBoardById" parameterType="string">
    UPDATE BOARD
       SET DEL_YN = 'Y'
     WHERE ID = #{id}
       AND DEL_YN = 'N'
    </update>
</mapper>